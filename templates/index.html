<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LLM Chess Game</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Arial', sans-serif;
            background: #1e1e1e;
    color: white;
    min-height: 100vh;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    text-align: center;
    margin-bottom: 30px;
}

.header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.game-area {
    display: grid;
    grid-template-columns: 1fr 1fr 400px;
    gap: 30px;
    margin-bottom: 30px;
}

.board-container {
    background: #2d2d2d;
    border-radius: 15px;
    padding: 20px;
}

.model-selection {
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
}

.model-select-container {
    margin-bottom: 15px;
}

.model-select-container label {
    display: block;
    margin-bottom: 5px;
    color: #e0e0e0;
    font-weight: bold;
}

.model-select {
    width: 100%;
    padding: 12px;
    margin: 5px 0;
    background: #3d3d3d;
    color: white;
    border: 2px solid #4d4d4d;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.model-select:hover {
    border-color: #5d5d5d;
    background: #454545;
}

.model-select:focus {
    outline: none;
    border-color: #4CAF50;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}

.model-select option {
    background: #3d3d3d;
    color: white;
    padding: 10px;
}

.model-select option:checked {
    background: #4CAF50;
    color: white;
}

.btn {
    background: #4CAF50;
    border: none;
    color: white;
    padding: 12px 30px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: bold;
    transition: all 0.3s;
    width: 100%;
    margin-top: 10px;
}

.btn:hover {
    background: #45a049;
}

.btn:disabled {
    background: #666;
    cursor: not-allowed;
}

.chessboard {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
}

.players {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
}

.player {
    text-align: center;
    flex: 1;
}

.player.active {
    background: rgba(255,255,255,0.2);
    border-radius: 8px;
    padding: 10px;
}

.thinking-area {
    background: #2d2d2d;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    min-height: 150px;
    max-height: 300px;
    overflow-y: auto;
}

.thinking-text {
    font-family: monospace;
    font-size: 0.9rem;
    line-height: 1.4;
    color: #e0e0e0;
}

.moves-history {
    background: #2d2d2d;
    border-radius: 10px;
    padding: 15px;
    max-height: 200px;
    overflow-y: auto;
}

.move-item {
    padding: 5px;
    border-bottom: 1px solid #3d3d3d;
    font-family: monospace;
}

.game-status-area {
    text-align: center;
    margin-top: 15px;
}

.game-events {
    background: #2d2d2d;
    border-radius: 10px;
    padding: 15px;
    max-height: 150px;
    overflow-y: auto;
    margin-top: 10px;
}

.event-item {
    padding: 5px 0;
    border-bottom: 1px solid #3d3d3d;
    font-size: 0.9rem;
}

.event-error {
    color: #ff6b6b;
}

.event-success {
    color: #4CAF50;
}

.event-warning {
    color: #FFC107;
}

.chain-of-thought {
    background: #3d3d3d;
    border-left: 4px solid #4CAF50;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    font-family: monospace;
    font-size: 0.85rem;
    line-height: 1.4;
}

.thinking-streaming {
    border-left-color: #FFC107;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
    <h1>ü§ñ LLM Chess Game</h1>
    <p>Watch two AI models play chess</p>
</div>

<div class="game-area">
    <div class="board-container">
        <div class="model-selection">
            <div class="model-select-container">
                <label for="white-model-select">White Model:</label>
                <select class="model-select" id="white-model-select">
                    <option value="">Loading models...</option>
                </select>
            </div>
            <div class="model-select-container">
                <label for="black-model-select">Black Model:</label>
                <select class="model-select" id="black-model-select">
                    <option value="">Loading models...</option>
                </select>
            </div>
            <button class="btn" id="start-game" onclick="startGame()">Start Game</button>
        </div>

        <div class="players" id="players">
            <div class="player" id="white-player">
                <h3>‚ö™ White</h3>
                <p id="white-model">-</p>
            </div>
            <div class="player" id="black-player">
                <h3>‚ö´ Black</h3>
                <p id="black-model">-</p>
            </div>
        </div>

        <div class="chessboard" id="chessboard"></div>

        <div class="game-status-area">
            <p id="game-status">Select models and start game</p>
        </div>
    </div>

    <div class="thinking-container">
        <div class="thinking-area" id="white-thinking">
            <h3>üß† White's Analysis</h3>
            <div class="thinking-text" id="white-thinking-text">
                Waiting for analysis...
            </div>
            <div class="thinking-status" id="white-thinking-status"></div>
        </div>
        <div class="thinking-area" id="black-thinking">
            <h3>üß† Black's Analysis</h3>
            <div class="thinking-text" id="black-thinking-text">
                Waiting for analysis...
            </div>
            <div class="thinking-status" id="black-thinking-status"></div>
        </div>
    </div>

    <div class="game-info">
        <h3>üìù Move History</h3>
        <div class="moves-history" id="moves-history">
            <p>No moves yet</p>
        </div>

        <h3>‚ö†Ô∏è Game Events</h3>
        <div class="game-events" id="game-events">
            <p>No events</p>
        </div>
    </div>
</div>
</div>

<script>
const socket = io();
let board = null;
let game = new Chess();
let gameInProgress = false;

// Initialize chess board and load models
async function initializeGame() {
    try {
        // Initialize chess board only if the element exists
        const boardDiv = document.getElementById('chessboard');
        if (boardDiv) {
            const config = {
                draggable: false,
                position: 'start',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/alpha/{piece}.png'
            };
            board = Chessboard(boardDiv, config);
        } else {
            console.error('Chessboard element not found!');
        }

        // Load available models
        console.log('Fetching available models...');
        const response = await fetch('/api/available_models');
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const models = await response.json();
        console.log('Received models:', models);

        // Get select elements
        const whiteSelect = document.getElementById('white-model-select');
        const blackSelect = document.getElementById('black-model-select');
        
        if (!whiteSelect || !blackSelect) {
            throw new Error('Could not find select elements');
        }
        
        console.log('Found select elements:', { whiteSelect, blackSelect });
        
        // Clear existing options
        whiteSelect.innerHTML = '';
        blackSelect.innerHTML = '';
        
        // Add default options
        const defaultWhiteOption = document.createElement('option');
        defaultWhiteOption.value = '';
        defaultWhiteOption.textContent = 'Select White Model';
        whiteSelect.appendChild(defaultWhiteOption);
        
        const defaultBlackOption = document.createElement('option');
        defaultBlackOption.value = '';
        defaultBlackOption.textContent = 'Select Black Model';
        blackSelect.appendChild(defaultBlackOption);
        
        // Add model options
        models.forEach(model => {
            console.log('Adding model to dropdowns:', model);
            
            // Create white option
            const whiteOption = document.createElement('option');
            whiteOption.value = model;
            whiteOption.textContent = model;
            whiteSelect.appendChild(whiteOption);
            
            // Create black option
            const blackOption = document.createElement('option');
            blackOption.value = model;
            blackOption.textContent = model;
            blackSelect.appendChild(blackOption);
        });

        // Verify options were added
        console.log('White select options:', whiteSelect.options.length);
        console.log('Black select options:', blackSelect.options.length);
        console.log('Model loading complete');
        
        // Force a reflow to ensure the dropdowns are updated
        whiteSelect.style.display = 'none';
        whiteSelect.offsetHeight; // Force reflow
        whiteSelect.style.display = '';
        
        blackSelect.style.display = 'none';
        blackSelect.offsetHeight; // Force reflow
        blackSelect.style.display = '';
        
    } catch (error) {
        console.error('Error initializing game:', error);
        const whiteSelect = document.getElementById('white-model-select');
        const blackSelect = document.getElementById('black-model-select');
        if (whiteSelect) whiteSelect.innerHTML = '<option value="">Error loading models</option>';
        if (blackSelect) blackSelect.innerHTML = '<option value="">Error loading models</option>';
    }
}

// Call initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing game...');
    initializeGame();
});

function startGame() {
    const whiteModel = document.getElementById('white-model-select').value;
    const blackModel = document.getElementById('black-model-select').value;

    if (!whiteModel || !blackModel) {
        addGameEvent('Please select both models', 'error');
        return;
    }

    if (whiteModel === blackModel) {
        addGameEvent('Please select different models', 'error');
        return;
    }

    fetch('/api/start_game', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            white_model: whiteModel,
            black_model: blackModel
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'Game started') {
            gameInProgress = true;
            document.getElementById('start-game').disabled = true;
            document.getElementById('white-model').textContent = whiteModel;
            document.getElementById('black-model').textContent = blackModel;
            updateGameStatus('Game started - White to move');
            addGameEvent('Game started', 'success');
        }
    })
    .catch(error => {
        console.error('Error starting game:', error);
        addGameEvent('Failed to start game', 'error');
    });
}

function addGameEvent(message, type = 'info') {
    const eventsContainer = document.getElementById('game-events');
    const eventDiv = document.createElement('div');
    eventDiv.className = `event-item event-${type}`;
    eventDiv.textContent = message;
    eventsContainer.appendChild(eventDiv);
    eventsContainer.scrollTop = eventsContainer.scrollHeight;
}

function updateGameStatus(status) {
    document.getElementById('game-status').textContent = status;
}

function updateChainOfThought(model, thinking, isStreaming) {
    const whiteModel = document.getElementById('white-model').textContent;
    const blackModel = document.getElementById('black-model').textContent;
    let color;
    if (model === whiteModel) {
        color = 'white';
    } else if (model === blackModel) {
        color = 'black';
    } else {
        // fallback: default to white
        color = 'white';
    }
    const thinkingArea = document.getElementById(`${color}-thinking-text`);
    const statusArea = document.getElementById(`${color}-thinking-status`);
    if (!thinkingArea || !statusArea) return;
    let thinkingHtml = '';
    if (thinking.includes('<thinking>') && thinking.includes('</thinking>')) {
        const start = thinking.indexOf('<thinking>') + 11;
        const end = thinking.indexOf('</thinking>');
        const cot = thinking.substring(start, end).trim();
        thinkingHtml = `
            <div class="chain-of-thought ${isStreaming ? 'thinking-streaming' : ''}">
                <div class="cot-header">
                    <strong>üß† ${model} Chain of Thought:</strong>
                    ${isStreaming ? '<span class="streaming-indicator">üîÑ</span>' : ''}
                </div>
                <div class="cot-content">
                    ${cot.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
    } else {
        thinkingHtml = `
            <div class="chain-of-thought ${isStreaming ? 'thinking-streaming' : ''}">
                <div class="cot-header">
                    <strong>üí≠ ${model} thinking:</strong>
                    ${isStreaming ? '<span class="streaming-indicator">üîÑ</span>' : ''}
                </div>
                <div class="cot-content">
                    ${thinking.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
    }
    thinkingArea.innerHTML = thinkingHtml;
    statusArea.textContent = isStreaming ? 'üîÑ Streaming thoughts...' : '‚úÖ Analysis complete';
    const container = document.getElementById(`${color}-thinking`);
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
}

function addMove(moveNumber, whiteSan, blackSan) {
    const movesHistory = document.getElementById('moves-history');
    
    if (moveNumber === 1 && whiteSan) {
        movesHistory.innerHTML = '';
    }
    
    const moveItem = document.createElement('div');
    moveItem.className = 'move-item';
    
    let moveText = `${moveNumber}. `;
    if (whiteSan) {
        moveText += whiteSan;
    }
    if (blackSan) {
        moveText += ` ${blackSan}`;
    }
    
    moveItem.innerHTML = moveText;
    movesHistory.appendChild(moveItem);
    movesHistory.scrollTop = movesHistory.scrollHeight;
}

// Socket event handlers
socket.on('thinking_stream', function(data) {
    updateChainOfThought(data.model, data.thinking, !data.complete);
});

socket.on('move_made', function(data) {
    updateBoardFromFEN(data.fen);
    addMove(data.move_number, data.white_san, data.black_san);
    addGameEvent(`${data.model}: ${data.san}`, 'success');
    
    if (data.game_over) {
        let resultText = '';
        if (data.result === '1-0') {
            resultText = 'White wins!';
        } else if (data.result === '0-1') {
            resultText = 'Black wins!';
        } else {
            resultText = 'Draw!';
        }
        updateGameStatus(`Game Over: ${resultText}`);
        addGameEvent(`Game finished: ${resultText}`, 'success');
        gameInProgress = false;
        document.getElementById('start-game').disabled = false;
    }
});

socket.on('move_error', function(data) {
    addGameEvent(`${data.model} move error: ${data.error}`, 'error');
});

function updateBoardFromFEN(fen) {
    game = new Chess(fen);
    if (board) {
        board.position(fen);
    }
}
</script>
</body>
</html>